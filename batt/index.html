<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>バッティングセンター3Dプロトタイプ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #222;
      overflow: hidden;
      height: 100%; width: 100%;
      touch-action: none;
    }
    #gameCanvas {
      display: block;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(to bottom, #4caf50 0%, #1b5e20 100%);
      touch-action: none;
    }
    #msg {
      position: absolute;
      top: 8px; left: 8px;
      width: 52vw;
      color: #fff;
      font-size: 0.95em;
      z-index: 2;
      text-shadow: 0 1px 2px #000;
      pointer-events: none;
      user-select: none;
    }
    #speed-control {
      position: absolute;
      right: 8px;
      bottom: 8px;
      background: #222e;
      border-radius: 9px;
      padding: 10px 12px;
      box-shadow: 0 2px 8px #0008;
      color: #fff;
      z-index: 10;
      text-align: center;
      font-size: 0.85em;
      user-select: none;
      width: 110px;
    }
    #speed-gauge {
      width: 80px;
      accent-color: #0ff;
      margin: 4px 0;
      height: 14px;
    }
    #random-btn {
      padding: 3px 6px;
      border: none;
      border-radius: 4px;
      background: #444;
      color: #fff;
      font-weight: bold;
      font-size: 0.75em;
      margin-bottom: 6px;
      cursor: pointer;
    }
    #random-btn.random-on {
      background: #e44;
    }
    #speed-label {
      font-size: 0.8em;
      font-weight: bold;
      margin-bottom: 2px;
      display: block;
    }
    #pitch-buttons {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }
    #pitch-buttons button {
      padding: 3px 4px;
      font-size: 0.75em;
      background: #444;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #pitch-buttons button.active {
      background: #0af;
    }
  </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="msg"></div>
<div id="speed-control">
  <span id="speed-label"></span>
  <input type="range" min="0" max="100" step="1" value="0" id="speed-gauge"><br>
  <button id="random-btn">速度ランダム</button>
  <div id="pitch-buttons">
    <button data-type="straight">直球</button>
    <button data-type="slider">スライダー</button>
    <button data-type="shoot">シュート</button>
    <button data-type="random">球種ランダム</button>
  </div>
</div>
<audio id="bat-audio" src="bat.mp3" preload="auto"></audio>
<audio id="mach-audio" src="mach.mp3" preload="auto"></audio>
<audio id="katch-audio" src="katch.mp3" preload="auto"></audio>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W = window.innerWidth;
let H = window.innerHeight;
canvas.width = W;
canvas.height = H;

// UI要素
const msg = document.getElementById('msg');
const speedGauge = document.getElementById('speed-gauge');
const randomBtn = document.getElementById('random-btn');
const speedLabel = document.getElementById('speed-label');
const batAudio = document.getElementById('bat-audio');
const machAudio = document.getElementById('mach-audio');
const katchAudio = document.getElementById('katch-audio');

// 定数と初期値
const MACHINE_X = W / 2;
let MACHINE_Y = H * 0.20;
const MACHINE_HEIGHT = 64;
const GAUGE_W = 24;
let GAUGE_H = MACHINE_HEIGHT;
let GAUGE_X = MACHINE_X - 50 - GAUGE_W;
let GAUGE_Y = MACHINE_Y - (MACHINE_HEIGHT / 2);

const BALL_START_RADIUS = 14;
const BALL_END_RADIUS = 32;
const SWIPE_R1 = 60;
const SWIPE_R2 = 45;
const HIT_DISTANCE_MARGIN = 48;

const SPEED_MIN = 0.0012;
const SPEED_MAX = 0.0045;
let userBallSpeed = SPEED_MIN;
let ballSpeed = SPEED_MIN;
let randomMode = false;

let startPoint = { x: W * 0.25, y: H * 0.5 };
let swingPoint = { x: W * 0.15, y: H * 0.68 };

let ball = null;
let ballReady = true;
let gauge = null;
let swipe = { active: false, path: [], hit: false };
let lastFoul = false;

// 球種システム（ナックル削除）
const pitchTypes = ["straight", "slider", "shoot"];
let selectedPitch = "straight";
let pitchRandom = false;

document.querySelectorAll("#pitch-buttons button").forEach(btn => {
  btn.addEventListener("click", () => {
    const type = btn.dataset.type;
    pitchRandom = (type === "random");
    selectedPitch = pitchRandom ? pitchTypes[Math.floor(Math.random() * pitchTypes.length)] : type;

    document.querySelectorAll("#pitch-buttons button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  });
});

// ボール初期化（1球ごとに球種抽選）
function resetBall() {
  ball = {
    t: 0,
    x: MACHINE_X,
    y: MACHINE_Y,
    r: BALL_START_RADIUS,
    flying: false,
    fade: 1,
    gone: false,
    isHit: false,
    vx: 0,
    vy: 0,
    vr: 0,
    foul: false
  };

  ballSpeed = randomMode
    ? SPEED_MIN + Math.random() * (SPEED_MAX - SPEED_MIN)
    : userBallSpeed;

  if (pitchRandom) {
    selectedPitch = pitchTypes[Math.floor(Math.random() * pitchTypes.length)];
  }

  updateSpeedLabel();
  ballReady = true;
  swipe.hit = false;
  swipe.path = [];
  gauge = null;
  lastFoul = false;
  showMsg("①に指を置いてゲージ『3』でボール発射");
}

// ゲージ開始
function startGauge() {
  gauge = {
    level: 0,
    active: true,
    finished: false,
    lastStepTime: performance.now()
  };
}

// ゲージ更新
function updateGauge(now) {
  if (!gauge || !gauge.active) return;
  const elapsed = now - gauge.lastStepTime;
  if (elapsed >= 300 && gauge.level < 3) {
    gauge.level++;
    gauge.lastStepTime = now;
    if (gauge.level === 3) {
      gauge.active = false;
      gauge.finished = true;
      setTimeout(() => {
        if (ballReady && ball && !ball.flying) {
          ballReady = false;
          try { machAudio.currentTime = 0; machAudio.play(); } catch(e){}
          ball.flying = true;
          showMsg("②を通るようにスイングしよう！");
        }
      }, 200);
    }
  }
}
</script>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W = window.innerWidth;
let H = window.innerHeight;
canvas.width = W;
canvas.height = H;

// UI要素
const msg = document.getElementById('msg');
const speedGauge = document.getElementById('speed-gauge');
const randomBtn = document.getElementById('random-btn');
const speedLabel = document.getElementById('speed-label');
const batAudio = document.getElementById('bat-audio');
const machAudio = document.getElementById('mach-audio');
const katchAudio = document.getElementById('katch-audio');

// 定数と初期値
const MACHINE_X = W / 2;
let MACHINE_Y = H * 0.20;
const MACHINE_HEIGHT = 64;
const GAUGE_W = 24;
let GAUGE_H = MACHINE_HEIGHT;
let GAUGE_X = MACHINE_X - 50 - GAUGE_W;
let GAUGE_Y = MACHINE_Y - (MACHINE_HEIGHT / 2);

const BALL_START_RADIUS = 14;
const BALL_END_RADIUS = 32;
const SWIPE_R1 = 60;
const SWIPE_R2 = 45;
const HIT_DISTANCE_MARGIN = 48;

const SPEED_MIN = 0.0012;
const SPEED_MAX = 0.0045;
let userBallSpeed = SPEED_MIN;
let ballSpeed = SPEED_MIN;
let randomMode = false;

let startPoint = { x: W * 0.25, y: H * 0.5 };
let swingPoint = { x: W * 0.15, y: H * 0.68 };

let ball = null;
let ballReady = true;
let gauge = null;
let swipe = { active: false, path: [], hit: false };
let lastFoul = false;

// 球種システム（ナックル削除）
const pitchTypes = ["straight", "slider", "shoot"];
let selectedPitch = "straight";
let pitchRandom = false;

document.querySelectorAll("#pitch-buttons button").forEach(btn => {
  btn.addEventListener("click", () => {
    const type = btn.dataset.type;
    pitchRandom = (type === "random");
    selectedPitch = pitchRandom ? pitchTypes[Math.floor(Math.random() * pitchTypes.length)] : type;

    document.querySelectorAll("#pitch-buttons button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  });
});

// ボール初期化（1球ごとに球種抽選）
function resetBall() {
  ball = {
    t: 0,
    x: MACHINE_X,
    y: MACHINE_Y,
    r: BALL_START_RADIUS,
    flying: false,
    fade: 1,
    gone: false,
    isHit: false,
    vx: 0,
    vy: 0,
    vr: 0,
    foul: false
  };

  ballSpeed = randomMode
    ? SPEED_MIN + Math.random() * (SPEED_MAX - SPEED_MIN)
    : userBallSpeed;

  if (pitchRandom) {
    selectedPitch = pitchTypes[Math.floor(Math.random() * pitchTypes.length)];
  }

  updateSpeedLabel();
  ballReady = true;
  swipe.hit = false;
  swipe.path = [];
  gauge = null;
  lastFoul = false;
  showMsg("①に指を置いてゲージ『3』でボール発射");
}

// ゲージ開始
function startGauge() {
  gauge = {
    level: 0,
    active: true,
    finished: false,
    lastStepTime: performance.now()
  };
}

// ゲージ更新
function updateGauge(now) {
  if (!gauge || !gauge.active) return;
  const elapsed = now - gauge.lastStepTime;
  if (elapsed >= 300 && gauge.level < 3) {
    gauge.level++;
    gauge.lastStepTime = now;
    if (gauge.level === 3) {
      gauge.active = false;
      gauge.finished = true;
      setTimeout(() => {
        if (ballReady && ball && !ball.flying) {
          ballReady = false;
          try { machAudio.currentTime = 0; machAudio.play(); } catch(e){}
          ball.flying = true;
          showMsg("②を通るようにスイングしよう！");
        }
      }, 200);
    }
  }
}
</script>
<script>
// ボール挙動更新（球種による変化含む）
function updateBall(dt) {
  if (!ball) return;

  if (ball.isHit) {
    ball.x += ball.vx * dt;
    ball.y += ball.vy * dt;
    ball.r += ball.vr * dt;
    ball.fade -= 0.003 * dt;
    if (ball.r < 2 || ball.x < -100 || ball.x > W+100 || ball.y < -100 || ball.y > H+100 || ball.fade <= 0) {
      setTimeout(resetBall, 800);
      ball.isHit = false;
      ball.fade = 0;
    }
    return;
  }

  if (ball.foul) {
    ball.y += 0.55 * dt;
    ball.fade -= 0.0029 * dt;
    if (ball.y > H + 60 || ball.fade <= 0) {
      setTimeout(resetBall, 800);
      ball.foul = false;
      ball.fade = 0;
    }
    return;
  }

  if (!ball.flying && !ball.gone) return;

  if (ball.flying) {
    ball.t += dt * ballSpeed;
    if (ball.t > 1) ball.t = 1;

    // 球種によるX軸変化（1球ごとに固定された selectedPitch を使用）
    let xOffset = 0;
    const t = ball.t;
    const curve = Math.sin(t * Math.PI);

    switch (selectedPitch) {
      case "slider": xOffset = curve * 40; break;
      case "shoot":  xOffset = -curve * 40; break;
      case "straight": default: xOffset = 0;
    }

    ball.x = MACHINE_X + xOffset;
    ball.y = MACHINE_Y + (H * 0.88 - MACHINE_Y) * t;
    ball.r = BALL_START_RADIUS + (BALL_END_RADIUS - BALL_START_RADIUS) * t;
    ball.fade = Math.max(0, 1 - (t - 0.8) * 4);
    if (ball.t >= 1) {
      ball.flying = false;
      if (!swipe.hit) {
        try { katchAudio.currentTime = 0; katchAudio.play(); } catch(e){}
        ball.foul = true;
        lastFoul = true;
      }
      ball.gone = true;
      setTimeout(resetBall, 800);
    }
  }
}

// スワイプ判定（①→②→ボール）＋①より上は無効
function checkSwipeSequence(path, r1, r2, ball) {
  for (let i = 0; i < path.length; i++) {
    if (path[i].y < startPoint.y) return false;
  }

  let idx1 = -1;
  for (let i = 0; i < path.length; i++) {
    if (Math.hypot(path[i].x - startPoint.x, path[i].y - startPoint.y) < r1) {
      idx1 = i;
      break;
    }
  }
  if (idx1 === -1) return false;

  let idx2 = -1;
  for (let i = idx1 + 1; i < path.length; i++) {
    if (Math.hypot(path[i].x - swingPoint.x, path[i].y - swingPoint.y) < r2) {
      idx2 = i;
      break;
    }
  }
  if (idx2 === -1) return false;

  let end = path[path.length - 1];
  if (Math.hypot(end.x - ball.x, end.y - ball.y) < ball.r + HIT_DISTANCE_MARGIN) {
    return true;
  }

  for (let i = idx2 + 1; i < path.length; i++) {
    let p0 = path[i - 1], p1 = path[i];
    let d0 = Math.hypot(p0.x - ball.x, p0.y - ball.y);
    let d1 = Math.hypot(p1.x - ball.x, p1.y - ball.y);
    if (d0 < ball.r + HIT_DISTANCE_MARGIN || d1 < ball.r + HIT_DISTANCE_MARGIN) return true;
  }

  return false;
}

// メッセージ表示
function showMsg(text) {
  msg.textContent = text;
}

// ヒット演出
function showHitEffect(hitType) {
  let text = hitType === "center" ? "ナイスバッティング！" : "ヒット！";
  showMsg(text);
}
</script>
<script>
function draw() {
  ctx.clearRect(0, 0, W, H);
  drawNet();

  // マシン本体（灰色）＋黒い出口のみ
  ctx.save();
  ctx.fillStyle = "#bbb";
  ctx.fillRect(MACHINE_X - 24, MACHINE_Y - MACHINE_HEIGHT/2, 48, MACHINE_HEIGHT);
  ctx.fillStyle = "#222";
  ctx.beginPath();
  ctx.arc(MACHINE_X, MACHINE_Y + 10, 18, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  // ゲージ
  if (gauge) {
    ctx.save();
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 2;
    ctx.strokeRect(GAUGE_X, GAUGE_Y, GAUGE_W, GAUGE_H);
    ctx.strokeStyle = "#fff6";
    ctx.lineWidth = 1.2;
    for (let i = 1; i < 3; i++) {
      let y = GAUGE_Y + GAUGE_H - (GAUGE_H/3)*i;
      ctx.beginPath();
      ctx.moveTo(GAUGE_X, y);
      ctx.lineTo(GAUGE_X + GAUGE_W, y);
      ctx.stroke();
    }
    ctx.fillStyle = "#f44";
    const filledH = GAUGE_H * (gauge.level / 3);
    ctx.fillRect(GAUGE_X, GAUGE_Y + GAUGE_H - filledH, GAUGE_W, filledH);

    ctx.font = "bold 12px sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#fff";
    for (let i = 0; i < 3; i++) {
      let y = GAUGE_Y + GAUGE_H - (GAUGE_H/6) - (GAUGE_H/3)*i;
      ctx.fillText((i+1).toString(), GAUGE_X + GAUGE_W/2, y);
    }
    ctx.restore();
  }

  // ①②円と誘導ライン
  ctx.save();
  ctx.strokeStyle = "#0ff";
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  ctx.ellipse(startPoint.x, startPoint.y, SWIPE_R1, SWIPE_R1, 0, 0, Math.PI*2);
  ctx.stroke();
  ctx.font = "bold 25px sans-serif";
  ctx.fillStyle = "#0ff";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("①", startPoint.x, startPoint.y);

  ctx.strokeStyle = "#ff0";
  ctx.beginPath();
  ctx.ellipse(swingPoint.x, swingPoint.y, SWIPE_R2, SWIPE_R2, 0, 0, Math.PI*2);
  ctx.stroke();
  ctx.fillStyle = "#ff0";
  ctx.fillText("②", swingPoint.x, swingPoint.y);

  ctx.strokeStyle = "#fff4";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(startPoint.x, startPoint.y);
  ctx.bezierCurveTo(
    startPoint.x - 10, startPoint.y + 30,
    swingPoint.x + 10, swingPoint.y - 30,
    swingPoint.x, swingPoint.y
  );
  ctx.stroke();
  ctx.restore();

  // ホームベース（五角形）XY逆配置
  ctx.save();
  ctx.fillStyle = "#fff";
  ctx.beginPath();
  const baseX = MACHINE_X;
  const baseY = swingPoint.y;
  const size = 24;
  ctx.moveTo(baseX, baseY);
  ctx.lineTo(baseX - size, baseY);
  ctx.lineTo(baseX - size, baseY + size);
  ctx.lineTo(baseX, baseY + size * 1.5);
  ctx.lineTo(baseX + size, baseY + size);
  ctx.lineTo(baseX + size, baseY);
  ctx.closePath();
  ctx.fill();
  ctx.restore();

  // スワイプ軌跡
  if (swipe.path.length > 1) {
    ctx.save();
    ctx.strokeStyle = "#fffa";
    ctx.lineWidth = 6;
    ctx.beginPath();
    for (let i=0; i<swipe.path.length; i++) {
      let p = swipe.path[i];
      if (i===0) ctx.moveTo(p.x, p.y);
      else ctx.lineTo(p.x, p.y);
    }
    ctx.stroke();
    ctx.restore();
  }

  // ボール（飛行中・ヒット・ファウル時のみ描画）
  if (ball && (ball.flying || ball.isHit || ball.foul)) {
    ctx.save();
    ctx.globalAlpha = Math.max(0, ball.fade);
    ctx.shadowColor = "#fff";
    ctx.shadowBlur = 12;
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, Math.max(2, ball.r), 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
}

// ネット描画
function drawNet() {
  ctx.save();
  ctx.strokeStyle = "#0f0a";
  ctx.lineWidth = 1.2;
  for (let i = -80; i <= 80; i += 16) {
    ctx.beginPath();
    ctx.moveTo(MACHINE_X + i, MACHINE_Y - 64);
    ctx.lineTo(MACHINE_X + i, MACHINE_Y + 64);
    ctx.stroke();
  }
  for (let j = -64; j <= 64; j += 16) {
    ctx.beginPath();
    ctx.moveTo(MACHINE_X - 80, MACHINE_Y + j);
    ctx.lineTo(MACHINE_X + 80, MACHINE_Y + j);
    ctx.stroke();
  }
  ctx.restore();
}
</script>
<script>
// タッチ操作
canvas.addEventListener("touchstart", e => {
  const t = e.touches[0];
  const dx = t.clientX - startPoint.x;
  const dy = t.clientY - startPoint.y;
  if (Math.sqrt(dx*dx + dy*dy) > SWIPE_R1) return;
  swipe.active = true;
  swipe.path = [{x: t.clientX, y: t.clientY}];
  swipe.hit = false;
  if (ballReady && !gauge) {
    startGauge();
    showMsg("ゲージ『3』でタイミングを合わせてスイング！");
  }
});

canvas.addEventListener("touchmove", e => {
  if (!swipe.active) return;
  const t = e.touches[0];
  swipe.path.push({x: t.clientX, y: t.clientY});
});

canvas.addEventListener("touchend", e => {
  if (!swipe.active || swipe.hit || !ball.flying) return;
  swipe.active = false;
  if (checkSwipeSequence(swipe.path, SWIPE_R1, SWIPE_R2, ball)) {
    swipe.hit = true;
    ball.flying = false;
    ball.isHit = true;
    let end = swipe.path[swipe.path.length-1];
    let relX = end.x - ball.x;
    let baseAngle = -Math.PI / 2;
    let angleOffset = Math.max(-Math.PI/6, Math.min(Math.PI/6, relX / 120));
    angleOffset += (Math.random()-0.5)*Math.PI/10;
    let angle = baseAngle + angleOffset;
    let power = 1.8 + Math.random()*0.8;
    ball.vx = Math.cos(angle) * power * 0.65;
    ball.vy = Math.sin(angle) * power * 0.92;
    ball.vr = -0.055 * power;
    ball.fade = 1;
    try { batAudio.currentTime = 0; batAudio.play(); } catch(e){}
    showHitEffect("center");
  } else {
    showMsg("①→②→ボールを通るようにスイングしてね");
    setTimeout(resetBall, 1200);
  }
});

// スピードUI更新
function updateSpeedLabel() {
  if (randomMode) {
    speedLabel.textContent = `速度: ランダム (${(ballSpeed*10000).toFixed(1)})`;
    randomBtn.classList.add('random-on');
  } else {
    let speedVal = Math.round(((userBallSpeed - SPEED_MIN) / (SPEED_MAX - SPEED_MIN)) * 100);
    speedLabel.textContent = `速度: ${speedVal} / 100 (${(ballSpeed*10000).toFixed(1)})`;
    randomBtn.classList.remove('random-on');
  }
  speedGauge.value = Math.round(((userBallSpeed - SPEED_MIN) / (SPEED_MAX - SPEED_MIN)) * 100);
}

speedGauge.addEventListener('input', function() {
  let v = Number(speedGauge.value) / 100;
  userBallSpeed = SPEED_MIN + v * (SPEED_MAX - SPEED_MIN);
  randomMode = false;
  ballSpeed = userBallSpeed;
  updateSpeedLabel();
});

randomBtn.addEventListener('click', function() {
  randomMode = !randomMode;
  updateSpeedLabel();
});

// ゲージ位置再設定
function setGaugePosition() {
  GAUGE_H = MACHINE_HEIGHT;
  GAUGE_X = MACHINE_X - 50 - GAUGE_W;
  GAUGE_Y = MACHINE_Y - (MACHINE_HEIGHT / 2);
}

// 描画ループ
let lastTime = performance.now();
function loop(now) {
  let dt = now - lastTime;
  lastTime = now;
  if (gauge) updateGauge(now);
  if (ball) updateBall(dt);
  draw();
  requestAnimationFrame(loop);
}

// リサイズ対応
window.addEventListener('resize', () => {
  W = window.innerWidth;
  H = window.innerHeight;
  canvas.width = W;
  canvas.height = H;
  MACHINE_Y = H * 0.20;
  setGaugePosition();
  startPoint.x = W * 0.25; startPoint.y = H * 0.5;
  swingPoint.x = W * 0.15; swingPoint.y = H * 0.68;
  resetBall();
});

// 初期化
setGaugePosition();
updateSpeedLabel();
resetBall();
loop(lastTime);
</script>
</body>
</html>