<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>3D Real Map Explorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; }
        #ui {
            position: absolute; top: 10px; left: 10px; color: #fff;
            background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px;
            font-size: 11px; z-index: 100; pointer-events: none;
        }
        #controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 200; }
        button { padding: 15px 25px; background: #22ccff; border: none; border-radius: 30px; font-weight: bold; }
        #debug { position: absolute; bottom: 80px; right: 10px; display: flex; flex-direction: column; gap: 5px; }
        .d-btn { background: #ff44aa; color: white; border: none; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div id="ui">
    <b>REAL MAP ENGINE</b><br>
    Lat: <span id="lat">--</span> / Lon: <span id="lon">--</span><br>
    Tile: <span id="tile-info">--</span>
</div>

<div id="controls"><button id="btn-start">マップ探索を開始</button></div>

<div id="debug">
    <button class="d-btn" onclick="debugMove(0, 0.0005)">↑北</button>
    <button class="d-btn" onclick="debugMove(0, -0.0005)">↓南</button>
    <button class="d-btn" onclick="debugMove(0.0005, 0)">→東</button>
    <button class="d-btn" onclick="debugMove(-0.0005, 0)">←西</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
    let scene, camera, renderer, player, mapMesh;
    let currentPos = { lat: 35.6895, lon: 139.6917 }; // 初期値: 東京
    const ZOOM = 18; // 地図のズームレベル（18は詳細な街路レベル）

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // プレイヤーアバター
        player = new THREE.Group();
        const marker = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshBasicMaterial({color: 0xff0000}));
        player.add(marker);
        scene.add(player);

        player.add(camera);
        camera.position.set(0, 15, 10);
        camera.lookAt(0,0,0);

        // 地図を貼るための板（1辺100メートルと仮定）
        const geo = new THREE.PlaneGeometry(100, 100);
        const mat = new THREE.MeshBasicMaterial({ color: 0xffffff });
        mapMesh = new THREE.Mesh(geo, mat);
        mapMesh.rotation.x = -Math.PI / 2;
        scene.add(mapMesh);

        updateMapTile(currentPos.lat, currentPos.lon);
        setupTouch();
        animate();
    }

    // 緯度経度からOSMのタイル番号(x, y)を計算
    function lon2tile(lon, zoom) { return (Math.floor((lon + 180) / 360 * Math.pow(2, zoom))); }
    function lat2tile(lat, zoom) {
        return (Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom)));
    }

    // 地図画像を更新
    function updateMapTile(lat, lon) {
        const x = lon2tile(lon, ZOOM);
        const y = lat2tile(lat, ZOOM);
        const url = `https://tile.openstreetmap.org/${ZOOM}/${x}/${y}.png`;
        
        document.getElementById('tile-info').innerText = `${ZOOM}/${x}/${y}`;
        document.getElementById('lat').innerText = lat.toFixed(5);
        document.getElementById('lon').innerText = lon.toFixed(5);

        new THREE.TextureLoader().load(url, (tex) => {
            mapMesh.material.map = tex;
            mapMesh.material.needsUpdate = true;
        });
    }

    function debugMove(dLon, dLat) {
        currentPos.lat += dLat;
        currentPos.lon += dLon;
        updateMapTile(currentPos.lat, currentPos.lon);
    }

    function setupTouch() {
        let isDown = false, px = 0;
        window.addEventListener('touchstart', e => { isDown = true; px = e.touches[0].clientX; });
        window.addEventListener('touchmove', e => {
            if(!isDown) return;
            player.rotation.y -= (e.touches[0].clientX - px) * 0.01;
            px = e.touches[0].clientX;
        });
        window.addEventListener('touchend', () => isDown = false);
    }

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }

    document.getElementById('btn-start').onclick = () => {
        init();
        document.getElementById('btn-start').style.display = 'none';
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                currentPos.lat = p.coords.latitude;
                currentPos.lon = p.coords.longitude;
                updateMapTile(currentPos.lat, currentPos.lon);
            });
        }
    };
</script>
</body>
</html>
