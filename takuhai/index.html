<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®…é…DEATH - ãƒ ã‚µã‚·é‹è¼¸ç‰©èª</title>
    <style>
        /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å›ºå®š */
        body { 
            background: #1a1a1a; color: #fff; font-family: sans-serif; text-align: center; 
            margin: 0; padding: 0; overflow: hidden; height: 100vh; width: 100vw;
            display: flex; flex-direction: column; touch-action: manipulation; 
        }

        .flash-red { background-color: #ff0000 !important; }
        @keyframes shake {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-4px, -4px); }
            20% { transform: translate(4px, 2px); }
            100% { transform: translate(0, 0); }
        }
        .shake-screen { animation: shake 0.1s infinite; }

        /* å„ç¨®ç”»é¢ */
        .screen { 
            position: absolute; width: 100%; height: 100%; background: #000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; 
        }
        .main-visual { width: 50%; max-width: 200px; margin-bottom: 10px; border: 2px solid #ff4444; border-radius: 10px; }
        .menu-btn { width: 220px; padding: 10px; margin: 5px; background: #222; color: #fff; border: 2px solid #ff4444; border-radius: 30px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .menu-btn:disabled { border-color: #444; color: #444; }

        /* è¨­å®šãƒ»éŠã³ã‹ãŸãƒ‘ãƒãƒ« */
        .config-box { background: #222; padding: 15px; border-radius: 15px; border: 1px solid #444; width: 85%; max-width: 320px; }
        .guide-content { text-align: left; font-size: 12px; line-height: 1.5; color: #ccc; margin-bottom: 10px; }
        .guide-item { margin-bottom: 5px; border-bottom: 1px solid #333; }

        /* ã‚²ãƒ¼ãƒ è¡¨ç¤ºãƒ¡ã‚¤ãƒ³ */
        #game-view { 
            display: none; flex-direction: column; width: 100%; height: 100vh; overflow: hidden; 
        }

        /* UIãƒ‘ãƒãƒ«ï¼ˆä¸Šéƒ¨ï¼‰ */
        #ui-panel { 
            height: 50px; background: #222; border-bottom: 2px solid #00fbff; 
            display: flex; flex-direction: column; justify-content: center; flex-shrink: 0;
        }
        .info-row { display: flex; justify-content: center; gap: 15px; font-size: 12px; }
        .gas-bar-bg { width: 60px; height: 10px; background: #000; border: 1px solid #555; display: inline-block; vertical-align: middle; }
        #gas-bar-fill { width: 100%; height: 100%; background: #00ff00; }

        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ï¼ˆä¸­å¤®ï¼‰ */
        #game-container { 
            flex-grow: 1; display: flex; justify-content: center; align-items: center; 
            background: #111; overflow: hidden; position: relative;
        }
        canvas { background: #fff; border: 2px solid #444; max-width: 95vw; max-height: 95%; }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼ˆä¸‹éƒ¨ï¼‰ */
        .controls { 
            height: 160px; background: #1a1a1a; flex-shrink: 0;
            display: grid; grid-template-areas: ". up ." "left . right" ". down ."; 
            gap: 5px; justify-content: center; align-content: center; padding-bottom: 10px;
        }
        .btn { 
            width: 60px; height: 60px; background: #333; border: 2px solid #666; border-radius: 15px; 
            color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; 
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .btn-up { grid-area: up; }
        .btn-left { grid-area: left; } 
        .btn-right { grid-area: right; }
        .btn-down { grid-area: down; }
        .btn:active { background: #00fbff; color: #000; transform: scale(0.95); }

        #next-btn { 
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            padding: 15px 30px; background: #ff4444; color: #fff; border-radius: 10px; font-size: 20px; z-index: 10; 
        }
    </style>
</head>
<body>

    <audio id="chimeSound" src="chime.mp3" preload="auto"></audio>

    <div id="start-screen" class="screen">
        <img src="logo.png" alt="Logo" class="main-visual">
        <div id="stg-info" style="margin-bottom: 10px; color: #ff4444; font-size: 13px;">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šè‡ªå‹•ä¿å­˜</div>
        <button class="menu-btn" onclick="startGame(true)">ã¯ã˜ã‚ã‹ã‚‰</button>
        <button id="continue-btn" class="menu-btn" onclick="startGame(false)">ç¶šãã‹ã‚‰å†é–‹</button>
        <button class="menu-btn" style="border-color:#00fbff; color:#00fbff;" onclick="showScreen('config-screen')">ã˜ã£ãã‚Šãƒ¢ãƒ¼ãƒ‰ (ä¿å­˜ãªã—)</button>
        <button class="menu-btn" style="border-color:#aaa; color:#aaa;" onclick="showScreen('guide-screen')">éŠã³ã‹ãŸ</button>
    </div>

    <div id="guide-screen" class="screen" style="display:none;">
        <div class="config-box">
            <h3 style="margin:0 0 10px 0; color:#ff4444;">éŠã³ã‹ãŸ</h3>
            <div class="guide-content">
                <div class="guide-item">ğŸššã§ã™ã¹ã¦ã®ğŸ ã«è·ç‰©ã‚’å±Šã‘ã‚ï¼</div>
                <div class="guide-item"><b>é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</b>ï¼šæœ€çŸ­æ­©æ•°ã´ã£ãŸã‚Šã€‚ãƒŸã‚¹ä¸å¯ã€‚è‡ªå‹•ä¿å­˜ã€‚</div>
                <div class="guide-item"><b>ã˜ã£ãã‚Šãƒ¢ãƒ¼ãƒ‰</b>ï¼šä¿å­˜ãªã—ã€‚ã‚·ãƒ“ã‚¢è¨­å®šã§<b>å·¥äº‹(ğŸš§)</b>ç™ºç”Ÿã€‚</div>
            </div>
            <button class="menu-btn" style="width:100%; border-color:#555;" onclick="showScreen('start-screen')">æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="config-screen" class="screen" style="display:none;">
        <div class="config-box">
            <h3 style="margin:0 0 10px 0;">ã‚µã‚¤ã‚ºé¸æŠ</h3>
            <div style="margin-bottom:15px; color:#00fbff;">
                <input type="checkbox" id="severe-check"> ã‚·ãƒ“ã‚¢ãƒ¢ãƒ¼ãƒ‰(å·¥äº‹/ä½™ç™½5)
            </div>
            <button class="menu-btn" style="width:100%;" onclick="startCustomMode(11, 11)">ã‚¹ãƒ¢ãƒ¼ãƒ« (11x11)</button>
            <button class="menu-btn" style="width:100%;" onclick="startCustomMode(15, 15)">ãƒŸãƒ‰ãƒ« (15x15)</button>
            <button class="menu-btn" style="width:100%;" onclick="startCustomMode(17, 17)">ãƒ©ãƒ¼ã‚¸ (17x17)</button>
            <button class="menu-btn" style="width:100%; border-color:#555;" onclick="showScreen('start-screen')">æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="game-view">
        <div id="ui-panel">
            <button style="position:absolute; right:5px; top:5px; font-size:10px; padding:2px 5px;" onclick="location.reload()">EXIT</button>
            <div class="info-row">
                <div id="mode-label">--</div>
                <div>GAS <div class="gas-bar-bg"><div id="gas-bar-fill"></div></div> <span id="gas-val">--</span></div>
                <div>ğŸ“¦:<span id="cargo-count">--</span></div>
            </div>
            <div id="msg" style="color:#00fbff; font-size:11px; margin-top:2px;">READY...</div>
        </div>
        <div id="game-container">
            <canvas id="gameCanvas"></canvas>
            <button id="next-btn" onclick="nextStage()">NEXT STAGE</button>
        </div>
        <div class="controls">
            <div class="btn btn-up" onclick="handleMove(0,-1)">â–²</div>
            <div class="btn btn-left" onclick="handleMove(-1,0)">â—€</div>
            <div class="btn btn-down" onclick="handleMove(0,1)">â–¼</div>
            <div class="btn btn-right" onclick="handleMove(1,0)">â–¶</div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const chime = document.getElementById('chimeSound');
    let currentSTG = 1, player = {x:1, y:1, facingRight: true}, gas, maxGas, map, rows, cols, tileSize, gameOver, currentStageData = null;
    let isSevereMode = false, isCustomMode = false, moveCount = 0, constructionSites = []; 

    window.onload = () => {
        const savedData = localStorage.getItem('delivery_death_save');
        if (savedData) {
            const data = JSON.parse(savedData);
            document.getElementById('stg-info').innerText = `é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šSTAGE ${data.stg} ä¸­æ–­ä¸­`;
            document.getElementById('continue-btn').disabled = false;
        } else {
            document.getElementById('continue-btn').disabled = true;
        }
    };

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.getElementById(id).style.display = 'flex';
    }

    function startCustomMode(w, h) {
        isCustomMode = true; isSevereMode = document.getElementById('severe-check').checked;
        document.getElementById('mode-label').innerText = isSevereMode ? "STRICT+5" : "JUST FIT";
        document.getElementById('config-screen').style.display = 'none';
        document.getElementById('game-view').style.display = 'flex';
        generateStage(1, w, h);
    }

    function startGame(reset) {
        isCustomMode = false; isSevereMode = false;
        document.getElementById('mode-label').innerText = "NORMAL";
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-view').style.display = 'flex';

        if (!reset) {
            const savedData = localStorage.getItem('delivery_death_save');
            if (savedData) {
                const data = JSON.parse(savedData);
                currentSTG = data.stg;
                currentStageData = { map: data.map, maxGas: data.maxGas, cols: data.cols, rows: data.rows };
                initLevel(); return;
            }
        }
        currentSTG = 1; generateStage(currentSTG);
    }

    function generateStage(stg, w, h) {
        if (w) { cols = w; rows = h; }
        else {
            cols = Math.min(9 + Math.floor(stg/2) * 2, 17); 
            rows = Math.min(9 + Math.floor(stg/3) * 2, 17);
        }
        map = Array.from({length: rows}, () => Array(cols).fill(1));
        const dig = (x, y) => {
            map[y][x] = 0;
            const dirs = [[0,1],[0,-1],[1,0],[-1,0]].sort(() => Math.random() - 0.5);
            for (let [dx, dy] of dirs) {
                let nx = x + dx*2, ny = y + dy*2;
                if (nx > 0 && nx < cols-1 && ny > 0 && ny < rows-1 && map[ny][nx] === 1) {
                    map[y+dy][x+dx] = 0; dig(nx, ny);
                }
            }
        };
        dig(1, 1);
        for(let i=0; i<Math.floor((rows*cols)/15); i++){ 
            let rx = Math.floor(Math.random()*(cols-2))+1, ry = Math.floor(Math.random()*(rows-2))+1;
            if(map[ry][rx] === 1) map[ry][rx] = 0; 
        }
        let floors = []; 
        for(let r=1; r<rows-1; r++) for(let c=1; c<cols-1; c++) if(map[r][c]===0 && (r!==1||c!==1)) floors.push({c,r});
        floors.sort(() => Math.random() - 0.5);
        let houseCount = w ? Math.floor(cols*rows/25) + 2 : Math.min(3 + Math.floor(stg/2), 12);
        for(let i=0; i<houseCount; i++) { if(floors[i]) map[floors[i].r][floors[i].c] = 3; }

        let totalDist = 0, curX = 1, curY = 1, tempHouses = [];
        for(let r=0; r<rows; r++) for(let c=0; c<cols; c++) if(map[r][c]===3) tempHouses.push({c,r});
        while(tempHouses.length > 0) {
            tempHouses.sort((a,b) => getDist(curX, curY, a.c, a.r, map) - getDist(curX, curY, b.c, b.r, map));
            let next = tempHouses.shift();
            totalDist += getDist(curX, curY, next.c, next.r, map);
            curX = next.c; curY = next.r;
        }
        
        let margin = isSevereMode ? 5 : 0; 
        currentStageData = { map: JSON.parse(JSON.stringify(map)), maxGas: totalDist + margin, cols, rows };
        if (!isCustomMode) {
            localStorage.setItem('delivery_death_save', JSON.stringify({
                stg: currentSTG, map: currentStageData.map, maxGas: currentStageData.maxGas, cols, rows
            }));
        }
        initLevel();
    }

    function initLevel() {
        document.getElementById('game-view').classList.remove('shake-screen');
        document.body.classList.remove('flash-red');
        map = JSON.parse(JSON.stringify(currentStageData.map));
        gas = currentStageData.maxGas; maxGas = currentStageData.maxGas;
        cols = currentStageData.cols; rows = currentStageData.rows;
        player = {x:1, y:1, facingRight: true}; moveCount = 0; constructionSites = [];
        gameOver = false;
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('msg').innerText = `READY...`;
        
        // ç”»é¢ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ã‚¿ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
        const containerW = document.getElementById('game-container').clientWidth;
        const containerH = document.getElementById('game-container').clientHeight;
        tileSize = Math.min(Math.floor(containerW * 0.9 / cols), Math.floor(containerH * 0.9 / rows), 40);

        const dpr = window.devicePixelRatio || 1;
        canvas.style.width = (cols * tileSize) + 'px';
        canvas.style.height = (rows * tileSize) + 'px';
        canvas.width = cols * tileSize * dpr;
        canvas.height = rows * tileSize * dpr;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        updateUI(); draw();
    }

    function handleMove(dx, dy) {
        if(gameOver) return;
        if(dx === 1) player.facingRight = true; else if(dx === -1) player.facingRight = false;
        let nx = player.x + dx, ny = player.y + dy;
        if(map[ny] && map[ny][nx] !== 1 && map[ny][nx] !== 4) {
            player.x = nx; player.y = ny; gas--; moveCount++;
            if(map[ny][nx] === 3) {
                map[ny][nx] = 0; chime.pause(); chime.currentTime = 0; chime.play().catch(()=>{});
            }
            if(isSevereMode && moveCount % 5 === 0) closeRandomRoadLogic();
            updateUI(); checkStatus(); draw();
        }
    }

    function closeRandomRoadLogic() {
        let candidates = [];
        for(let r=1; r<rows-1; r++) {
            for(let c=1; c<cols-1; c++) {
                if(map[r][c] === 0 && (r !== player.y || c !== player.x)) {
                    let dist = Math.abs(c - player.x) + Math.abs(r - player.y);
                    if(dist > 1 && dist < 12) {
                        let openPaths = 0;
                        [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dx, dy]) => {
                            if(map[r+dy][c+dx] === 0 || map[r+dy][c+dx] === 3) openPaths++;
                        });
                        if(openPaths >= 2) candidates.push({r,c});
                    }
                }
            }
        }
        if(candidates.length > 0) {
            candidates.sort(() => Math.random() - 0.5);
            for(let t of candidates) {
                if(canStillClear(t.r, t.c)) {
                    if (constructionSites.length >= 2) {
                        let old = constructionSites.shift(); map[old.r][old.c] = 0;
                    }
                    map[t.r][t.c] = 4; constructionSites.push({r: t.r, c: t.c});
                    document.getElementById('msg').innerText = "ğŸš§ ROAD CLOSED";
                    document.getElementById('msg').style.color = "#ff4444";
                    setTimeout(() => { if(!gameOver) document.getElementById('msg').style.color = "#00fbff"; }, 1000);
                    break;
                }
            }
        }
    }

    function canStillClear(r, c) {
        let original = map[r][c]; map[r][c] = 4;
        let houses = [];
        for(let y=0; y<rows; y++) for(let x=0; x<cols; x++) if(map[y][x] === 3) houses.push({x,y});
        let possible = true;
        for(let h of houses) { if(getDist(player.x, player.y, h.x, h.y, map) >= 999) { possible = false; break; } }
        map[r][c] = original; return possible;
    }

    function draw() {
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, cols * tileSize, rows * tileSize);
        for(let y=0; y<rows; y++) {
            for(let x=0; x<cols; x++) {
                if(map[y][x] === 1) { ctx.fillStyle = '#333'; ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize); }
                else if(map[y][x] === 4) {
                    ctx.font = `${tileSize*0.7}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    ctx.fillText('ğŸš§', x*tileSize+tileSize/2, y*tileSize+tileSize/2);
                } else { ctx.strokeStyle = "#eee"; ctx.strokeRect(x*tileSize, y*tileSize, tileSize, tileSize); }
                if(map[y][x] === 3) { 
                    ctx.font = `${tileSize*0.7}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle"; 
                    ctx.fillText('ğŸ ', x*tileSize+tileSize/2, y*tileSize+tileSize/2); 
                }
            }
        }
        ctx.save(); ctx.translate(player.x*tileSize+tileSize/2, player.y*tileSize+tileSize/2);
        if(player.facingRight) ctx.scale(-1, 1);
        ctx.font = `${tileSize*0.8}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText('ğŸšš', 0, 0); ctx.restore();
    }

    function updateUI() {
        let count = 0; for(let y=0; y<rows; y++) for(let x=0; x<cols; x++) if(map[y][x] === 3) count++;
        document.getElementById('gas-val').innerText = gas;
        document.getElementById('cargo-count').innerText = count;
        document.getElementById('gas-bar-fill').style.width = (gas/maxGas*100) + '%';
        document.getElementById('gas-bar-fill').style.background = gas < 3 ? '#ff4444' : '#00ff00';
    }

    function checkStatus() {
        let count = 0; for(let y=0; y<rows; y++) for(let x=0; x<cols; x++) if(map[y][x] === 3) count++;
        if(count === 0) {
            gameOver = true; document.getElementById('msg').innerText = "SUCCESS!";
            document.getElementById('next-btn').style.display = 'block';
            if(!isCustomMode) localStorage.removeItem('delivery_death_save');
        } else if(gas <= 0) {
            gameOver = true; document.getElementById('msg').innerText = "OUT OF FUEL!";
            document.getElementById('game-view').classList.add('shake-screen');
            let f = 0; const flash = setInterval(() => {
                document.body.classList.toggle('flash-red');
                if(++f >= 10) { clearInterval(flash); setTimeout(() => initLevel(), 500); }
            }, 60);
        }
    }

    function getDist(x1, y1, x2, y2, m) {
        let q = [[x1, y1, 0]], v = new Set([x1+','+y1]);
        while(q.length > 0) {
            let [cx, cy, d] = q.shift(); if(cx === x2 && cy === y2) return d;
            for(let [dx, dy] of [[0,1],[0,-1],[1,0],[-1,0]]) {
                let nx = cx+dx, ny = cy+dy;
                if(nx>=0 && nx<cols && ny>=0 && ny<rows && m[ny][nx]!==1 && m[ny][nx]!==4 && !v.has(nx+','+ny)) {
                    v.add(nx+','+ny); q.push([nx, ny, d+1]);
                }
            }
        } return 999;
    }

    function nextStage() { 
        if(isCustomMode) { generateStage(1, cols, rows); } 
        else { currentSTG++; generateStage(currentSTG); }
    }
</script>
</body>
</html>
