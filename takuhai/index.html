<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂÆÖÈÖçDEATH - Strategy Delivery</title>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: 'Courier New', Courier, monospace; text-align: center; margin: 0; overflow: hidden; touch-action: manipulation; }
        
        /* „Çø„Ç§„Éà„É´„Éª„É°„Éã„É•„ÉºÁîªÈù¢ */
        #start-screen { position: absolute; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; border: 5px solid #ff4444; box-sizing: border-box; }
        .title-logo { font-size: 56px; font-weight: bold; color: #ff4444; text-shadow: 4px 4px 0 #550000; margin-bottom: 10px; }
        .sub-title { font-size: 18px; color: #00fbff; margin-bottom: 40px; letter-spacing: 5px; }
        .menu-btn { width: 250px; padding: 15px; margin: 10px; background: #111; color: #00fbff; border: 2px solid #00fbff; border-radius: 5px; font-size: 20px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .menu-btn:hover { background: #00fbff; color: #000; }
        .menu-btn:disabled { border-color: #333; color: #333; cursor: not-allowed; }

        /* „Ç≤„Éº„É†ÁîªÈù¢ */
        #game-view { display: none; }
        #ui-panel { background: #222; padding: 10px; border-bottom: 3px solid #00fbff; }
        .info-row { display: flex; justify-content: space-around; align-items: center; font-weight: bold; }
        .gas-bar-bg { width: 120px; height: 16px; background: #000; border-radius: 8px; border: 1px solid #555; overflow: hidden; }
        #gas-bar-fill { width: 100%; height: 100%; background: #00ff00; transition: width 0.2s; }
        #msg { color: #00fbff; font-size: 14px; font-weight: bold; margin: 5px; height: 24px; }
        #game-container { background: #fff; border: 2px solid #444; display: inline-block; margin-top: 5px; position: relative; }
        canvas { display: block; }

        /* Êìç‰Ωú„Éë„Éç„É´ */
        .controls { display: grid; grid-template-areas: ". up ." "left down right"; gap: 10px; justify-content: center; margin-top: 10px; }
        .btn { width: 70px; height: 70px; background: #333; border: 2px solid #666; border-radius: 15px; color: white; font-size: 32px; display: flex; align-items: center; justify-content: center; user-select: none; }
        .btn:active { background: #00fbff; color: #000; border-color: #fff; }
        #next-btn { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px 40px; background: #ff4444; color: #fff; font-weight: bold; border: none; cursor: pointer; z-index: 10; font-size: 24px; box-shadow: 0 0 20px #ff0000; }
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="title-logo">TAKUHAI DEATH</div>
        <div class="sub-title">~ REVERSE CALCULATION ~</div>
        <div id="stg-info" style="margin-bottom: 25px; color: #ff4444; font-weight: bold;"></div>
        <button class="menu-btn" onclick="startGame(true)">„ÅØ„Åò„ÇÅ„Åã„Çâ (STG 1)</button>
        <button id="continue-btn" class="menu-btn" onclick="startGame(false)">Á∂ö„Åç„Åã„Çâ (RESUME)</button>
    </div>

    <div id="game-view">
        <div id="ui-panel">
            <div class="info-row">
                <div>STG: <span id="stg-num">1</span></div>
                <div style="display:flex; align-items:center; gap:5px;">
                    GAS <div class="gas-bar-bg"><div id="gas-bar-fill"></div></div> <span id="gas-val">--</span>
                </div>
                <div>üì¶: <span id="cargo-count">--</span></div>
            </div>
            <div id="msg">...</div>
        </div>
        <div id="game-container">
            <canvas id="gameCanvas"></canvas>
            <button id="next-btn" onclick="nextStage()">NEXT STAGE</button>
        </div>
        <div class="controls">
            <div class="btn" style="grid-area:up" onclick="handleMove(0,-1)">‚ñ≤</div>
            <div class="btn" style="grid-area:left" onclick="handleMove(-1,0)">‚óÄ</div>
            <div class="btn" style="grid-area:down" onclick="handleMove(0,1)">‚ñº</div>
            <div class="btn" style="grid-area:right" onclick="handleMove(1,0)">‚ñ∂</div>
        </div>
        <button onclick="location.reload()" style="margin-top:15px; background:none; border:none; color:#555; text-decoration:underline; font-size:12px; cursor:pointer;">EXIT TO TITLE</button>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const msgEl = document.getElementById('msg');
    const nextBtn = document.getElementById('next-btn');
    const startScreen = document.getElementById('start-screen');
    const gameView = document.getElementById('game-view');
    const continueBtn = document.getElementById('continue-btn');
    const stgInfo = document.getElementById('stg-info');

    let currentSTG = 1;
    let player = {x:1, y:1, facingRight: true}, gas, maxGas, map, rows, cols, tileSize, gameOver;

    window.onload = () => {
        const savedSTG = localStorage.getItem('delivery_death_stg');
        if (savedSTG && parseInt(savedSTG) > 1) {
            currentSTG = parseInt(savedSTG);
            stgInfo.innerText = `LAST CLEAR: STG ${currentSTG - 1}`;
            continueBtn.disabled = false;
        } else {
            stgInfo.innerText = "READY TO DELIVER?";
            continueBtn.disabled = true;
        }
    };

    function startGame(reset) {
        if (reset) {
            currentSTG = 1;
            localStorage.setItem('delivery_death_stg', 1);
        }
        startScreen.style.display = 'none';
        gameView.style.display = 'block';
        generateStage(currentSTG);
    }

    function getDist(x1, y1, x2, y2) {
        let q = [[x1, y1, 0]], v = new Set([x1+','+y1]);
        while(q.length > 0) {
            let [cx, cy, d] = q.shift();
            if(cx === x2 && cy === y2) return d;
            for(let [dx, dy] of [[0,1],[0,-1],[1,0],[-1,0]]) {
                let nx = cx+dx, ny = cy+dy;
                if(nx>=0 && nx<cols && ny>=0 && ny<rows && map[ny][nx]!==1 && !v.has(nx+','+ny)) {
                    v.add(nx+','+ny); q.push([nx, ny, d+1]);
                }
            }
        }
        return 999;
    }

    function generateStage(stg) {
        cols = Math.min(13 + Math.floor(stg/2) * 2, 23);
        rows = Math.min(11 + Math.floor(stg/3) * 2, 19);
        map = Array.from({length: rows}, () => Array(cols).fill(1));

        const dig = (x, y) => {
            map[y][x] = 0;
            const dirs = [[0,1],[0,-1],[1,0],[-1,0]].sort(() => Math.random() - 0.5);
            for (let [dx, dy] of dirs) {
                let nx = x + dx*2, ny = y + dy*2;
                if (nx > 0 && nx < cols-1 && ny > 0 && ny < rows-1 && map[ny][nx] === 1) {
                    map[y+dy][x+dx] = 0; dig(nx, ny);
                }
            }
        };
        dig(1, 1);

        // ÂàÜÂ≤êÂ¢óÂº∑Ôºà„É´„Éº„ÉóÊßãÈÄ†Ôºâ
        let breakCount = Math.floor((rows * cols) / 10);
        for(let i=0; i<breakCount; i++){
            let rx = Math.floor(Math.random()*(cols-2))+1;
            let ry = Math.floor(Math.random()*(rows-2))+1;
            if(map[ry][rx] === 1) map[ry][rx] = 0;
        }

        let floors = [];
        for(let r=1; r<rows-1; r++) for(let c=1; c<cols-1; c++) if(map[r][c]===0 && (r!==1||c!==1)) floors.push({c,r});
        floors.sort(() => Math.random() - 0.5);
        let houseCount = Math.min(4 + Math.floor(stg/1.5), 15);
        let houses = [];
        for(let i=0; i<houseCount; i++) {
            let f = floors[i]; map[f.r][f.c] = 3; houses.push(f);
        }

        // TSPËøë‰ºº„Å´„Çà„ÇãÊúÄÁü≠ÁµåË∑ØÈÄÜÁÆó
        let totalDist = 0, curX = 1, curY = 1, tempHouses = [...houses];
        while(tempHouses.length > 0) {
            tempHouses.sort((a,b) => getDist(curX, curY, a.c, a.r) - getDist(curX, curY, b.c, b.r));
            let next = tempHouses.shift();
            totalDist += getDist(curX, curY, next.c, next.r);
            curX = next.c; curY = next.r;
        }

        // Áå∂‰∫àÊ≠©Êï∞ÔºàSTG„ÅåÈÄ≤„ÇÄ„Å®Ê•µÈôê„Åæ„ÅßÊ∏õ„ÇãÔºâ
        let margin = Math.max(1, 4 - Math.floor(stg/3));
        maxGas = totalDist + margin;
        gas = maxGas;
        player = {x:1, y:1, facingRight: true};
        gameOver = false;
        nextBtn.style.display = 'none';
        msgEl.innerText = `ESTIMATED: ${totalDist} / MARGIN: ${margin}`;
        msgEl.style.color = "#00fbff";
        
        tileSize = Math.min(Math.floor((window.innerWidth - 20) / cols), 35);
        canvas.width = cols * tileSize; canvas.height = rows * tileSize;
        updateUI(); draw();
    }

    function draw() {
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        for(let y=0; y<rows; y++) {
            for(let x=0; x<cols; x++) {
                if(map[y][x] === 1) {
                    ctx.fillStyle = '#333'; ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize);
                } else {
                    ctx.strokeStyle = "#ddd"; ctx.strokeRect(x*tileSize, y*tileSize, tileSize, tileSize);
                }
                if(map[y][x] === 3) {
                    ctx.font = `${tileSize*0.7}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    ctx.fillText('üè†', x*tileSize+tileSize/2, y*tileSize+tileSize/2);
                }
            }
        }
        ctx.save();
        ctx.translate(player.x*tileSize+tileSize/2, player.y*tileSize+tileSize/2);
        // Âè≥Âêë„Åç(facingRight=true)„ÅÆ„Å®„ÅçÂèçËª¢„Åï„Åõ„ÄÅÂè≥„Å´Âêë„Åã„Åõ„ÇãÔºàüöö„ÅØ„Éá„Éï„Ç©„É´„ÉàÂ∑¶Ôºâ
        if(player.facingRight) ctx.scale(-1, 1);
        ctx.font = `${tileSize*0.8}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.fillText('üöö', 0, 0);
        ctx.restore();
    }

    function handleMove(dx, dy) {
        if(gameOver) return;
        if(dx === 1) player.facingRight = true;
        if(dx === -1) player.facingRight = false;
        let nx = player.x + dx, ny = player.y + dy;
        if(map[ny] && map[ny][nx] !== 1) {
            player.x = nx; player.y = ny; gas--;
            if(map[ny][nx] === 3) map[ny][nx] = 0;
            updateUI(); checkStatus(); draw();
        }
    }

    function updateUI() {
        let count = 0;
        for(let y=0; y<rows; y++) for(let x=0; x<cols; x++) if(map[y][x] === 3) count++;
        document.getElementById('stg-num').innerText = currentSTG;
        document.getElementById('gas-val').innerText = gas;
        document.getElementById('cargo-count').innerText = count;
        document.getElementById('gas-bar-fill').style.width = (gas/maxGas*100) + '%';
        document.getElementById('gas-bar-fill').style.background = gas < 4 ? '#ff4444' : '#00ff00';
    }

    function checkStatus() {
        let count = 0;
        for(let y=0; y<rows; y++) for(let x=0; x<cols; x++) if(map[y][x] === 3) count++;
        if(count === 0) {
            gameOver = true;
            msgEl.innerText = "MISSION COMPLETE!";
            nextBtn.style.display = 'block';
            localStorage.setItem('delivery_death_stg', currentSTG + 1);
        } else if(gas <= 0) {
            gameOver = true;
            msgEl.innerText = "DEAD: OUT OF GAS";
            setTimeout(() => generateStage(currentSTG), 1200);
        }
    }

    function nextStage() { currentSTG++; generateStage(currentSTG); }

    window.addEventListener('keydown', e => {
        if(e.key==='ArrowUp') handleMove(0,-1);
        if(e.key==='ArrowDown') handleMove(0,1);
        if(e.key==='ArrowLeft') handleMove(-1,0);
        if(e.key==='ArrowRight') handleMove(1,0);
        if(e.key.includes('Arrow')) e.preventDefault();
    });
</script>
</body>
</html>
