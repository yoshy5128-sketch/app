<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®…é…DEATH - ãƒ ã‚µã‚·é‹è¼¸ç‰©èª</title>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: sans-serif; text-align: center; margin: 0; overflow: hidden; touch-action: manipulation; transition: background-color 0.1s; }
        
        /* å¤±æ•—æ™‚ã®èµ¤ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
        .flash-red { background-color: #ff0000 !important; }

        /* ç”»é¢ã‚’æºã‚‰ã™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-10px, -10px); }
            20% { transform: translate(10px, 5px); }
            30% { transform: translate(-5px, 10px); }
            40% { transform: translate(5px, -5px); }
            50% { transform: translate(-10px, 5px); }
            60% { transform: translate(10px, -10px); }
            70% { transform: translate(-5px, -5px); }
            80% { transform: translate(5px, 10px); }
            90% { transform: translate(-10px, -5px); }
            100% { transform: translate(0, 0); }
        }
        .shake-screen { animation: shake 0.1s infinite; }

        .screen { position: absolute; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; overflow-y: auto; }
        .main-visual { width: 80%; max-width: 400px; margin-bottom: 15px; border: 2px solid #ff4444; border-radius: 10px; }
        .menu-btn { width: 260px; padding: 12px; margin: 8px; background: #222; color: #fff; border: 2px solid #ff4444; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; flex-shrink: 0; }
        .menu-btn:disabled { border-color: #444; color: #666; cursor: not-allowed; }
        .guide-content { width: 85%; max-width: 500px; text-align: left; background: #222; padding: 20px; border-radius: 10px; border: 1px solid #444; margin-bottom: 20px; font-size: 14px; line-height: 1.6; }
        .guide-h { color: #ff4444; font-weight: bold; border-bottom: 1px solid #ff4444; margin-bottom: 10px; }
        #save-list-screen { background: rgba(0,0,0,0.95); z-index: 200; display: none; }
        .save-item { background: #333; margin: 8px auto; width: 85%; padding: 12px; border-radius: 10px; border-left: 5px solid #00fbff; display: flex; justify-content: space-between; align-items: center; }
        #game-view { display: none; position: relative; background: #1a1a1a; width: 100vw; height: 100vh; }
        #ui-panel { background: #222; padding: 8px 5px; border-bottom: 3px solid #00fbff; position: relative; }
        .info-row { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 5px; font-size: 14px; } 
        .gas-bar-bg { width: 60px; height: 10px; background: #000; border-radius: 5px; border: 1px solid #555; overflow: hidden; margin: 0 5px; }
        #gas-bar-fill { width: 100%; height: 100%; background: #00ff00; }
        .sub-btns { margin-top: 5px; display: flex; justify-content: center; gap: 10px; }
        .action-btn { background: #444; color: #fff; border: 1px solid #666; padding: 4px 10px; font-size: 11px; border-radius: 4px; }
        #exit-btn { position: absolute; right: 4px; top: 4px; background: #333; color: #888; border: 1px solid #444; padding: 2px 6px; font-size: 10px; border-radius: 3px; }
        #game-container { background: #fff; border: 2px solid #444; display: inline-block; margin-top: 5px; position: relative; }
        canvas { display: block; image-rendering: -webkit-optimize-contrast; }
        .controls { display: grid; grid-template-areas: ". up ." "left . right" ". down ."; gap: 5px; justify-content: center; margin-top: 10px; }
        .btn { width: 75px; height: 75px; background: #333; border: 2px solid #666; border-radius: 15px; color: white; font-size: 28px; display: flex; align-items: center; justify-content: center; user-select: none; }
        .btn-up { grid-area: up; }
        .btn-left { grid-area: left; margin-top: -38px; } 
        .btn-right { grid-area: right; margin-top: -38px; }
        .btn-down { grid-area: down; margin-top: -38px; }
        .btn:active { background: #00fbff; color: #000; }
        #next-btn { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px 40px; background: #ff4444; color: #fff; font-weight: bold; border-radius: 10px; z-index: 10; font-size: 24px; }
    </style>
</head>
<body onclick="unlockAudio()">

    <audio id="chimeSound" src="chime.mp3" preload="auto"></audio>

    <div id="start-screen" class="screen">
        <img src="logo.png" alt="Visual" class="main-visual">
        <div id="stg-info" style="margin-bottom: 10px; color: #ff4444; font-weight: bold; font-size: 14px;"></div>
        <button class="menu-btn" onclick="startGame(true)">ã¯ã˜ã‚ã‹ã‚‰</button>
        <button id="continue-btn" class="menu-btn" onclick="startGame(false)">ç¶šãã‹ã‚‰å†é–‹</button>
        <button class="menu-btn" style="border-color:#00fbff" onclick="showSaveList()">ä¿å­˜ã—ãŸé…é”ã‚’éŠã¶</button>
        <button class="menu-btn" style="border-color:#aaa; font-size:14px;" onclick="showGuide()">éŠã³ã‹ãŸ</button>
    </div>

    <div id="guide-screen" class="screen" style="display:none;">
        <h2 style="color:#ff4444">ãƒ ã‚µã‚·é‹è¼¸ æ¥­å‹™ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h2>
        <div class="guide-content">
            <div class="guide-h">â—† ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°</div>
            ã‚ãªãŸã¯é›¶ç´°é‹é€ä¼šç¤¾ã€ãƒ ã‚µã‚·é‹è¼¸ã®å¥‘ç´„ç¤¾å“¡ã§ã™ã€‚å€’ç”£å¯¸å‰ã§ã‚¬ã‚½ãƒªãƒ³ã¯æ¥µå°‘ã€‚æœ€çŸ­ãƒ«ãƒ¼ãƒˆã§é…é”ã—ã¦ãã ã•ã„ã€‚
            <br><br>
            <div class="guide-h">â—† éŠã³æ–¹</div>
            ãƒ»ã‚¬ã‚½ãƒªãƒ³ã¯æ¥µå°‘ã§ã™ã€‚1ãƒã‚¹ã®ç„¡é§„ã‚‚è¨±ã•ã‚Œã¾ã›ã‚“ã€‚<br>
            ãƒ»ã€ŒSKIPã€ãƒœã‚¿ãƒ³ã§é…è»Šãƒ«ãƒ¼ãƒˆã‚’å¤‰æ›´ã§ãã¾ã™ã€‚<br>
            ãƒ»æ°—ã«å…¥ã£ãŸãƒ«ãƒ¼ãƒˆã¯ã€Œé…é”ä¿å­˜ã€ã§ãã¾ã™ã€‚
        </div>
        <button class="menu-btn" onclick="hideGuide()">äº†è§£ã—ãŸ</button>
    </div>

    <div id="save-list-screen" class="screen">
        <h2 style="color:#00fbff">é…é”è¨˜éŒ²</h2>
        <div id="list-container" style="width:100%"></div>
        <button class="menu-btn" onclick="document.getElementById('save-list-screen').style.display='none'">ã‚‚ã©ã‚‹</button>
    </div>

    <div id="game-view">
        <div id="ui-panel">
            <button id="exit-btn" onclick="location.reload()">EXIT</button>
            <div class="info-row">
                <div>STG: <span id="stg-num">1</span></div>
                <div style="display:flex; align-items:center;">
                    GAS <div class="gas-bar-bg"><div id="gas-bar-fill"></div></div> <span id="gas-val">--</span>
                </div>
                <div>ğŸ“¦: <span id="cargo-count">--</span></div>
            </div>
            <div class="sub-btns">
                <button class="action-btn" onclick="generateStage(currentSTG)">SKIP (ãƒ«ãƒ¼ãƒˆå¤‰æ›´)</button>
                <button class="action-btn" style="border-color:#00fbff" onclick="saveCurrentMap()">é…é”ä¿å­˜</button>
            </div>
            <div id="msg" style="color:#00fbff; font-size:11px; margin-top:5px; height:14px;">READY...</div>
        </div>
        <div id="game-container">
            <canvas id="gameCanvas"></canvas>
            <button id="next-btn" onclick="nextStage()">NEXT STAGE</button>
        </div>
        <div class="controls">
            <div class="btn btn-up" onclick="handleMove(0,-1)">â–²</div>
            <div class="btn btn-left" onclick="handleMove(-1,0)">â—€</div>
            <div class="btn btn-down" onclick="handleMove(0,1)">â–¼</div>
            <div class="btn btn-right" onclick="handleMove(1,0)">â–¶</div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const chime = document.getElementById('chimeSound');
    let currentSTG = 1, player = {x:1, y:1, facingRight: true}, gas, maxGas, map, rows, cols, tileSize, gameOver, currentStageData = null;

    window.onload = () => {
        const savedSTG = localStorage.getItem('delivery_death_stg');
        if (savedSTG && parseInt(savedSTG) > 1) {
            currentSTG = parseInt(savedSTG);
            document.getElementById('stg-info').innerText = `RECORDS: STG ${currentSTG - 1} CLEAR`;
            document.getElementById('continue-btn').disabled = false;
        } else {
            currentSTG = 1;
            document.getElementById('stg-info').innerText = "NO RECORDS";
            document.getElementById('continue-btn').disabled = true;
        }
    };

    function unlockAudio() { chime.play().then(() => { chime.pause(); chime.currentTime = 0; }).catch(() => {}); }
    function showGuide() { document.getElementById('guide-screen').style.display = 'flex'; }
    function hideGuide() { document.getElementById('guide-screen').style.display = 'none'; }

    function startGame(reset) {
        if (reset) { currentSTG = 1; localStorage.setItem('delivery_death_stg', 1); } 
        else { const savedSTG = localStorage.getItem('delivery_death_stg'); currentSTG = savedSTG ? parseInt(savedSTG) : 1; }
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-view').style.display = 'block';
        generateStage(currentSTG);
    }

    function saveCurrentMap() { const d = JSON.parse(localStorage.getItem('delivery_saved_maps') || '[]'); d.push({ id: Date.now(), date: new Date().toLocaleString(), stg: currentSTG, data: currentStageData }); localStorage.setItem('delivery_saved_maps', JSON.stringify(d)); alert("ä¿å­˜ã—ã¾ã—ãŸ"); }
    function showSaveList() { const c = document.getElementById('list-container'); const d = JSON.parse(localStorage.getItem('delivery_saved_maps') || '[]'); c.innerHTML = d.length ? '' : '<p>è¨˜éŒ²ãªã—</p>'; d.reverse().forEach(i => { const v = document.createElement('div'); v.className = 'save-item'; v.innerHTML = `<div style="text-align:left"><b>STG ${i.stg}</b><br><small>${i.date}</small></div><div><button class="action-btn" onclick="loadSavedMap(${i.id})">å‡ºç™º</button><button style="color:red;border:none;background:none" onclick="deleteSave(${i.id})">âœ–</button></div>`; c.appendChild(v); }); document.getElementById('save-list-screen').style.display = 'flex'; }
    function deleteSave(id) { let d = JSON.parse(localStorage.getItem('delivery_saved_maps') || '[]'); d = d.filter(i => i.id !== id); localStorage.setItem('delivery_saved_maps', JSON.stringify(d)); showSaveList(); }
    function loadSavedMap(id) { const d = JSON.parse(localStorage.getItem('delivery_saved_maps') || '[]'); const t = d.find(i => i.id === id); if (t) { currentSTG = t.stg; currentStageData = t.data; document.getElementById('save-list-screen').style.display = 'none'; document.getElementById('start-screen').style.display = 'none'; document.getElementById('game-view').style.display = 'block'; initLevel(); } }

    function getDist(x1, y1, x2, y2, m) {
        let q = [[x1, y1, 0]], v = new Set([x1+','+y1]);
        while(q.length > 0) {
            let [cx, cy, d] = q.shift(); if(cx === x2 && cy === y2) return d;
            for(let [dx, dy] of [[0,1],[0,-1],[1,0],[-1,0]]) { let nx = cx+dx, ny = cy+dy; if(nx>=0 && nx<cols && ny>=0 && ny<rows && m[ny][nx]!==1 && !v.has(nx+','+ny)) { v.add(nx+','+ny); q.push([nx, ny, d+1]); } }
        } return 999;
    }

    function generateStage(stg) {
        currentSTG = stg; cols = Math.min(13 + Math.floor(stg/2) * 2, 23); rows = Math.min(11 + Math.floor(stg/3) * 2, 19);
        map = Array.from({length: rows}, () => Array(cols).fill(1));
        const dig = (x, y) => { map[y][x] = 0; const dirs = [[0,1],[0,-1],[1,0],[-1,0]].sort(() => Math.random() - 0.5); for (let [dx, dy] of dirs) { let nx = x + dx*2, ny = y + dy*2; if (nx > 0 && nx < cols-1 && ny > 0 && ny < rows-1 && map[ny][nx] === 1) { map[y+dy][x+dx] = 0; dig(nx, ny); } } };
        dig(1, 1);
        for(let i=0; i<Math.floor((rows*cols)/10); i++){ let rx = Math.floor(Math.random()*(cols-2))+1, ry = Math.floor(Math.random()*(rows-2))+1; if(map[ry][rx] === 1) map[ry][rx] = 0; }
        let floors = []; for(let r=1; r<rows-1; r++) for(let c=1; c<cols-1; c++) if(map[r][c]===0 && (r!==1||c!==1)) floors.push({c,r});
        floors.sort(() => Math.random() - 0.5); let houseCount = Math.min(4 + Math.floor(stg/1.5), 15); for(let i=0; i<houseCount; i++) { map[floors[i].r][floors[i].c] = 3; }
        let totalDist = 0, curX = 1, curY = 1, tempHouses = []; for(let r=0; r<rows; r++) for(let c=0; c<cols; c++) if(map[r][c]===3) tempHouses.push({c,r});
        while(tempHouses.length > 0) { tempHouses.sort((a,b) => getDist(curX, curY, a.c, a.r, map) - getDist(curX, curY, b.c, b.r, map)); let next = tempHouses.shift(); totalDist += getDist(curX, curY, next.c, next.r, map); curX = next.c; curY = next.r; }
        let margin = Math.max(1, 4 - Math.floor(stg/3)); currentStageData = { map: JSON.parse(JSON.stringify(map)), maxGas: totalDist + margin, totalDist, margin, cols, rows }; initLevel();
    }

    function initLevel() {
        document.getElementById('game-view').classList.remove('shake-screen');
        document.body.classList.remove('flash-red');
        map = JSON.parse(JSON.stringify(currentStageData.map)); gas = currentStageData.maxGas; maxGas = currentStageData.maxGas;
        cols = currentStageData.cols; rows = currentStageData.rows; player = {x:1, y:1, facingRight: true}; gameOver = false; document.getElementById('next-btn').style.display = 'none';
        document.getElementById('msg').innerText = `MIN: ${currentStageData.totalDist} / MARGIN: ${currentStageData.margin}`;
        const dpr = window.devicePixelRatio || 1; tileSize = Math.min(Math.floor((window.innerWidth - 20) / cols), 35);
        canvas.style.width = (cols * tileSize) + 'px'; canvas.style.height = (rows * tileSize) + 'px'; canvas.width = cols * tileSize * dpr; canvas.height = rows * tileSize * dpr; ctx.setTransform(dpr, 0, 0, dpr, 0, 0); updateUI(); draw();
    }

    function handleMove(dx, dy) {
        if(gameOver) return; if(dx === 1) player.facingRight = true; else if(dx === -1) player.facingRight = false;
        let nx = player.x + dx, ny = player.y + dy;
        if(map[ny] && map[ny][nx] !== 1) {
            player.x = nx; player.y = ny; gas--;
            if(map[ny][nx] === 3) { map[ny][nx] = 0; chime.currentTime = 0; chime.play().catch(()=>{}); }
            updateUI(); checkStatus(); draw();
        }
    }

    function draw() {
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, cols * tileSize, rows * tileSize);
        for(let y=0; y<rows; y++) { for(let x=0; x<cols; x++) { if(map[y][x] === 1) { ctx.fillStyle = '#333'; ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize); } else { ctx.strokeStyle = "#eee"; ctx.lineWidth = 1; ctx.strokeRect(x*tileSize + 0.5, y*tileSize + 0.5, tileSize - 1, tileSize - 1); } if(map[y][x] === 3) { ctx.font = `bold ${tileSize*0.7}px sans-serif`; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText('ğŸ ', x*tileSize+tileSize/2, y*tileSize+tileSize/2); } } }
        ctx.save(); ctx.translate(player.x*tileSize+tileSize/2, player.y*tileSize+tileSize/2); if(player.facingRight) ctx.scale(-1, 1); ctx.font = `bold ${tileSize*0.8}px sans-serif`; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText('ğŸšš', 0, 0); ctx.restore();
    }

    function updateUI() {
        let count = 0; for(let y=0; y<rows; y++) for(let x=0; x<cols; x++) if(map[y][x] === 3) count++;
        document.getElementById('stg-num').innerText = currentSTG; document.getElementById('gas-val').innerText = gas; document.getElementById('cargo-count').innerText = count; document.getElementById('gas-bar-fill').style.width = (gas/maxGas*100) + '%'; document.getElementById('gas-bar-fill').style.background = gas < 4 ? '#ff4444' : '#00ff00';
    }

    function checkStatus() {
        let count = 0; for(let y=0; y<rows; y++) for(let x=0; x<cols; x++) if(map[y][x] === 3) count++;
        if(count === 0) { 
            gameOver = true; document.getElementById('msg').innerText = "SUCCESS!"; document.getElementById('next-btn').style.display = 'block'; 
            localStorage.setItem('delivery_death_stg', currentSTG + 1);
        }
        else if(gas <= 0) { 
            gameOver = true; 
            document.getElementById('msg').innerText = "DEAD: OUT OF FUEL"; 
            
            // æ¿€ã—ã„æ¼”å‡ºã®å®Ÿè¡Œ
            const gameView = document.getElementById('game-view');
            gameView.classList.add('shake-screen');
            
            let flashCount = 0;
            const flashEffect = setInterval(() => {
                document.body.classList.toggle('flash-red');
                flashCount++;
                if(flashCount >= 14) { // æ¿€ã—ã7å›å¾€å¾©
                    clearInterval(flashEffect);
                    setTimeout(() => initLevel(), 500); // æ¼”å‡ºå¾Œã«ãƒªã‚»ãƒƒãƒˆ
                }
            }, 60); // é«˜é€Ÿãƒ•ãƒ©ãƒƒã‚·ãƒ¥
        }
    }

    function nextStage() { currentSTG++; generateStage(currentSTG); }
    window.addEventListener('keydown', e => { if(gameOver) return; if(e.key==='ArrowUp') handleMove(0,-1); if(e.key==='ArrowDown') handleMove(0,1); if(e.key==='ArrowLeft') handleMove(-1,0); if(e.key==='ArrowRight') handleMove(1,0); if(e.key.includes('Arrow')) e.preventDefault(); });
</script>
</body>
</html>