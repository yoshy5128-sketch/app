<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Everest Simulator</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', Courier, monospace; touch-action: none; }
        #top-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url('top.png') no-repeat center center; background-size: cover;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 500; color: white; text-shadow: 2px 2px 10px rgba(0,0,0,0.8);
        }
        #title-logo { font-size: 32px; font-weight: bold; margin-bottom: 20px; letter-spacing: 5px; }
        .menu-btn { padding: 12px 25px; font-size: 16px; font-weight: bold; cursor: pointer; border: 2px solid white; background: rgba(0,0,0,0.5); color: white; margin: 8px; width: 220px; }
        
        /* コンパクトな計器類 */
        #instrument-panel { position: absolute; top: 8px; left: 8px; color: #00ff00; background: rgba(0, 20, 0, 0.8); padding: 6px; border: 1px solid #00ff00; z-index: 10; font-size: 9px; min-width: 100px; pointer-events: none; }
        .data-value { font-weight: bold; font-size: 11px; color: #fff; }
        #o2-container { width: 100%; height: 6px; background: #003300; border: 1px solid #00ff00; margin-top: 3px; }
        #o2-bar { width: 100%; height: 100%; background: #00ff00; }

        /* 操作系 */
        #step-btn-container { position: absolute; bottom: 25px; left: 25px; width: 90px; height: 90px; background: rgba(255, 255, 255, 0.2); border: 3px solid rgba(255,255,255,0.5); border-radius: 50%; z-index: 100; display: none; align-items: center; justify-content: center; user-select: none; -webkit-user-select: none; }
        #touch-look-area { position: absolute; top: 0; right: 0; width: 75%; height: 100%; z-index: 5; display: none; }

        /* マップ */
        #map-display { position: absolute; top: 8px; right: 8px; width: 80px; height: 80px; background: rgba(0, 40, 0, 0.6); border: 1px solid #00ff00; z-index: 10; }
        #player-icon { position: absolute; width: 8px; height: 12px; background: #fff; clip-path: polygon(50% 0%, 0% 100%, 50% 75%, 100% 100%); }
        
        #vision-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; opacity: 0; pointer-events: none; z-index: 100; }
        #message-screen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 2000; color: white; background: rgba(0,0,0,0.95); padding: 30px; border: 2px solid #fff; width: 80%; }
        #phase-notice { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: #ffff00; padding: 12px; border: 2px solid #ffff00; z-index: 150; display: none; text-align: center; font-size: 13px; }
    </style>
</head>
<body>

<div id="top-screen">
    <div id="title-logo">EVEREST SIMULATOR</div>
    <button class="menu-btn" id="start-climb-btn">START CLIMBING</button>
    <button class="menu-btn" onclick="document.getElementById('instructions-panel').style.display='block'">INSTRUCTIONS</button>
</div>

<div id="instructions-panel" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:80%; max-width:500px; background:rgba(0,0,0,0.95); border:2px solid #00ff00; padding:20px; color:#fff; z-index:600; display:none; font-size:12px;">
    <h3>遊び方</h3>
    <p>あなたは今から、エベレスト制覇を目指します！<br>ベースキャンプを出発し頂上を目指してください。<br>STEPボタンで進みます。右画面をなぞって向きを変えられます。</p>
    <button onclick="this.parentElement.style.display='none'" style="padding:8px 16px; background:#00ff00; border:none; cursor:pointer;">閉じる</button>
</div>

<div id="instrument-panel">
    <div id="stage-text" style="color:#ffff00; margin-bottom:3px;">PHASE: ASCENT</div>
    <div>ALT: <span id="alt-val" class="data-value">5364.00</span>m</div>
    <div>DST: <span id="dist-val" class="data-value">--</span>m</div>
    <div>WTR: <span id="weather-text" class="data-value">NORMAL</span></div>
    <div id="o2-container"><div id="o2-bar"></div></div>
</div>

<div id="map-display">
    <div id="bc-dot" style="position:absolute; width:5px; height:5px; background:#00aaff; border:1px solid #fff;"></div>
    <div id="summit-dot" style="position:absolute; width:5px; height:5px; background:#ff0000; clip-path:polygon(50% 0%, 0% 100%, 100% 100%);"></div>
    <div id="rescue-dot" style="position:absolute; width:8px; height:8px; background:#ffff00; display:none; clip-path:polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);"></div>
    <div id="player-icon"></div>
</div>

<div id="step-btn-container"><div style="color:white; font-weight:bold; font-size:18px;">STEP</div></div>
<div id="touch-look-area"></div>
<div id="vision-overlay"></div>
<div id="phase-notice"></div>
<div id="message-screen"><h1 id="msg-title"></h1><p id="msg-body"></p><button onclick="location.reload()" style="padding:10px 20px; cursor:pointer;">RETRY</button></div>

<script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>

<script type="module">
    import * as THREE from 'three';

    const START_ALT = 5364.0, TARGET_ALT = 8848.0, TERRAIN_SIZE = 6000;
    const START_POS_XZ = { x: 0, z: 2000 }, SUMMIT_POS_XZ = { x: 0, z: -2800 };
    
    // 感度の調整
    const TOUCH_SENSITIVITY = 0.018; 

    let gameState = 'ASCENT', oxygen = 100, isEnded = false, gameStartTime = 0, isStep = false;
    let rescuePos = null, rescueObj = null;

    // --- 3D Scene ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.5, 18000);
    camera.rotation.order = 'YXZ'; // 回転順序を固定
    
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    const listener = new THREE.AudioListener();
    camera.add(listener);
    const windSound = new THREE.Audio(listener);
    new THREE.AudioLoader().load('wind.mp3', (buffer) => {
        windSound.setBuffer(buffer); windSound.setLoop(true); windSound.setVolume(0);
    });

    function getH(x, z) {
        let h = (2500 - z) * 0.4 + Math.sin(x*0.002)*100 + Math.cos(z*0.002)*80;
        let d = Math.sqrt(x*x + (z+2800)**2);
        h += Math.max(0, 1200 - d*0.4) + Math.sin(x*0.02)*6 + Math.cos(z*0.02)*6;
        return h;
    }
    const baseH = getH(START_POS_XZ.x, START_POS_XZ.z);
    const peakH = getH(SUMMIT_POS_XZ.x, SUMMIT_POS_XZ.z);
    const hScale = (TARGET_ALT - START_ALT) / (peakH - baseH);

    const geo = new THREE.PlaneGeometry(TERRAIN_SIZE, TERRAIN_SIZE, 100, 100);
    geo.rotateX(-Math.PI/2);
    const v = geo.attributes.position.array;
    const colors = new Float32Array(v.length);
    for(let i=0; i<v.length; i+=3){
        v[i+1] = getH(v[i], v[i+2]);
        if(Math.sin(v[i]*0.015 + v[i+2]*0.01) > 0.99) v[i+1]-=600;
        let b = 0.8 + Math.random()*0.2;
        colors[i]=b; colors[i+1]=b; colors[i+2]=b+0.05;
    }
    geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    geo.computeVertexNormals();
    const terrainMesh = new THREE.Mesh(geo, new THREE.MeshPhongMaterial({vertexColors:true, shininess:10}));
    scene.add(terrainMesh);

    // Tents
    const colors_t = [0xff4444, 0x4444ff, 0xffff44, 0x44ff44];
    for(let i=0; i<12; i++){
        const tx = START_POS_XZ.x+(Math.random()-0.5)*80, tz = START_POS_XZ.z+(Math.random()-0.5)*80;
        const tent = new THREE.Mesh(new THREE.ConeGeometry(5,12,4), new THREE.MeshPhongMaterial({color:colors_t[i%4]}));
        tent.position.set(tx, getH(tx,tz)+6, tz);
        scene.add(tent);
    }

    scene.add(new THREE.AmbientLight(0xaaaaee, 0.6));
    const dl = new THREE.DirectionalLight(0xffffff, 1.2);
    dl.position.set(-1000, 2000, -1000); scene.add(dl);

    // Player State
    let player = { pos: new THREE.Vector3(START_POS_XZ.x, baseH+10, START_POS_XZ.z), velY:0, rotY:0, rotX:0, isFalling:false };
    const keys = {};

    document.getElementById('start-climb-btn').onclick = () => {
        if (THREE.AudioContext.getContext().state === 'suspended') THREE.AudioContext.getContext().resume();
        document.getElementById('top-screen').style.display = 'none';
        gameStartTime = performance.now();
        if(windSound.buffer) windSound.play();
        try { document.documentElement.requestFullscreen(); screen.orientation.lock('landscape').catch(()=>{}); } catch(e){}
        if(!isTouch) renderer.domElement.requestPointerLock();
    };

    const isTouch = (('ontouchstart' in window) || (navigator.maxTouchPoints > 0));
    if(isTouch){
        document.getElementById('step-btn-container').style.display='flex';
        document.getElementById('touch-look-area').style.display='block';
    }

    const sBtn = document.getElementById('step-btn-container');
    sBtn.addEventListener('touchstart', (e)=>{e.preventDefault(); isStep=true;}, {passive:false});
    sBtn.addEventListener('touchend', ()=>{isStep=false;});
    window.onkeydown=e=>keys[e.key.toLowerCase()]=true; window.onkeyup=e=>keys[e.key.toLowerCase()]=false;

    // --- 視点操作の修正 ---
    let lx = 0, ly = 0, tid = null;
    const lookArea = document.getElementById('touch-look-area');

    lookArea.addEventListener('touchstart', e => {
        e.preventDefault();
        const t = e.changedTouches[0];
        tid = t.identifier;
        lx = t.clientX;
        ly = t.clientY;
    }, { passive: false });

    window.addEventListener('touchmove', e => {
        if(tid === null) return;
        for(let t of e.changedTouches) {
            if(t.identifier === tid) {
                const dx = t.clientX - lx;
                const dy = t.clientY - ly;
                
                player.rotY -= dx * TOUCH_SENSITIVITY;
                player.rotX -= dy * TOUCH_SENSITIVITY;
                
                // 上下の角度制限
                player.rotX = Math.max(-1.4, Math.min(1.4, player.rotX));
                
                // 数値の肥大化を防ぐ
                player.rotY %= Math.PI * 2;

                lx = t.clientX;
                ly = t.clientY;
            }
        }
    }, { passive: false });

    window.addEventListener('touchend', e => {
        for(let t of e.changedTouches) if(t.identifier === tid) tid = null;
    });

    window.onmousemove=e=>{ 
        if(isEnded) return;
        if(document.pointerLockElement){ 
            player.rotY -= e.movementX * 0.002;
            player.rotX -= e.movementY * 0.002;
            player.rotX = Math.max(-1.4, Math.min(1.4, player.rotX)); 
        } 
    };

    const ray = new THREE.Raycaster();

    function animate(time) {
        if(isEnded) return;
        requestAnimationFrame(animate);

        let wCycle = (Math.sin(time*0.0003)+1)/2;
        document.getElementById('weather-text').innerText = wCycle > 0.75 ? "WHITEOUT" : "NORMAL";
        
        const fogD = 0.0002 + Math.pow(wCycle, 3)*0.04;
        scene.background = new THREE.Color().lerpColors(new THREE.Color(0x77aaff), new THREE.Color(0xcccccc), Math.min(1, wCycle*1.2));
        scene.fog = new THREE.FogExp2(scene.background, fogD);

        let moving = false;
        if(gameStartTime > 0 && !player.isFalling) {
            if(isStep || keys.w) {
                const fwd = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
                fwd.y=0; fwd.normalize(); player.pos.addScaledVector(fwd, 0.95); moving = true;
            }
            oxygen -= (moving ? 0.012 : 0.005);
            if(oxygen <= 0) { oxygen=0; document.getElementById('vision-overlay').style.opacity=1; showEnd("登山不能","酸素が尽きました。"); }
            document.getElementById('o2-bar').style.width = oxygen + "%";
            if(oxygen < 30) document.getElementById('vision-overlay').style.opacity = ((Math.sin(time*0.002)+1)/2) * ((30-oxygen)/30) * 0.8;
            if(windSound.isPlaying) windSound.setVolume(0.1 + Math.pow(wCycle, 2)*0.9);
        }

        // 接地判定
        ray.set(new THREE.Vector3(player.pos.x, 8000, player.pos.z), new THREE.Vector3(0,-1,0));
        const hits = ray.intersectObject(terrainMesh);
        if(hits.length > 0) {
            const gy = hits[0].point.y;
            const elapsed = performance.now() - gameStartTime;
            if (gameStartTime > 0 && elapsed < 3000) {
                player.pos.y = gy + 3; player.velY = 0;
            } else if (gameStartTime > 0) {
                if(gy < player.pos.y - 45) player.isFalling = true;
                if(player.isFalling) {
                    player.velY -= 0.8; if(player.pos.y < gy + 3) showEnd("滑落","クレバスに転落しました。");
                } else {
                    const ty = gy + 3; if(player.pos.y > ty) player.velY -= 0.2;
                    else { if(player.velY < -22) showEnd("滑落","滑落死しました。"); player.pos.y = ty; player.velY = 0; }
                }
            }
        }
        player.pos.y += player.velY;

        const dS = player.pos.distanceTo(new THREE.Vector3(SUMMIT_POS_XZ.x, peakH, SUMMIT_POS_XZ.z));
        const dB = player.pos.distanceTo(new THREE.Vector3(START_POS_XZ.x, baseH+3, START_POS_XZ.z));
        document.getElementById('alt-val').innerText = (START_ALT + (player.pos.y-(baseH+3))*hScale).toFixed(2);
        
        if(gameState==='ASCENT') {
            document.getElementById('dist-val').innerText = Math.floor(dS);
            if(gameStartTime > 0 && dS < 15) {
                gameState='DESCENT'; document.getElementById('stage-text').innerText="PHASE: DESCENT";
                const rx = SUMMIT_POS_XZ.x+(Math.random()-0.5)*500, rz = SUMMIT_POS_XZ.z+(Math.random()-0.5)*500;
                rescuePos = new THREE.Vector3(rx, getH(rx, rz), rz);
                rescueObj = new THREE.Mesh(new THREE.ConeGeometry(8,20,4), new THREE.MeshPhongMaterial({color:0xffff00}));
                rescueObj.position.set(rx, rescuePos.y+10, rz); scene.add(rescueObj);
                document.getElementById('rescue-dot').style.display='block'; document.getElementById('rescue-dot').style.left=(50+(rx/TERRAIN_SIZE)*100)+'%'; document.getElementById('rescue-dot').style.top=(50+(rz/TERRAIN_SIZE)*100)+'%';
                const n = document.getElementById('phase-notice'); n.innerHTML="登頂成功！<br>レスキュー(★)で酸素補給せよ"; n.style.display='block'; setTimeout(()=>n.style.display='none',5000);
            }
        } else {
            document.getElementById('dist-val').innerText = Math.floor(dB);
            if(rescuePos && player.pos.distanceTo(rescuePos) < 20) { oxygen=100; scene.remove(rescueObj); rescuePos=null; document.getElementById('rescue-dot').style.display='none'; }
            if(dB < 30) showEnd("完全制覇","おめでとう！無事帰還しました。");
        }

        const pIcon = document.getElementById('player-icon');
        pIcon.style.left=(50+(player.pos.x/TERRAIN_SIZE)*100)+'%'; pIcon.style.top=(50+(player.pos.z/TERRAIN_SIZE)*100)+'%';
        pIcon.style.transform=`translate(-50%,-50%) rotate(${-player.rotY*180/Math.PI}deg)`;
        document.getElementById('bc-dot').style.left=(50+(START_POS_XZ.x/TERRAIN_SIZE)*100)+'%';
        document.getElementById('bc-dot').style.top=(50+(START_POS_XZ.z/TERRAIN_SIZE)*100)+'%';
        document.getElementById('summit-dot').style.left=(50+(SUMMIT_POS_XZ.x/TERRAIN_SIZE)*100)+'%';
        document.getElementById('summit-dot').style.top=(50+(SUMMIT_POS_XZ.z/TERRAIN_SIZE)*100)+'%';

        camera.position.copy(player.pos); camera.rotation.set(player.rotX, player.rotY, 0);
        renderer.render(scene, camera);
    }

    function showEnd(t, b) {
        if(isEnded) return; isEnded=true; if(windSound.isPlaying) windSound.stop();
        if (document.exitPointerLock) document.exitPointerLock();
        document.getElementById('message-screen').style.display='block';
        document.getElementById('msg-title').innerText=t; document.getElementById('msg-body').innerText=b;
    }

    window.onresize=()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); };
    animate(0);

    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js', {updateViaCache: 'none'}); }
</script>
</body>
</html>
